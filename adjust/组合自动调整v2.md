# 组合自动调整

在这个功能模块中，我们为用户提供定期调整和条件触发两种组合调整方式。用户通过设定指标，由系统判定组合是否需要卖出，并自动为用户完成卖出操作。本功能只为用户进行风险监控，所以在操作上只卖出，不买入。

借助自动调整系统，用户可以不必时刻紧盯市场数据并操作，放心地让自动化工具来管理资产。

## 作用机制

首先，用户在系统界面，为股票挑选希望使用到的定期调整或者条件触发的指标，并根据指标含义自行设定指标数值。关于定期调整，用户还需要选定调整的时间周期。

接下来的工作就交给系统了。系统会在恰当的时机，根据当前的股票与其它信息，计算出指标值，并将其与用户设定的指标值进行比较。比较结果若为需要调整，则系统自动为用户进行卖出操作，并用短信、邮件等形式提醒用户。

## 定期调整

在定期调整部分，用户将设定一个时间周期，以及监测指标值。每经过一个周期，系统就会自动计算指标，并与用户设定值进行比对。若当前指标突破了用户设定的范围，就会执行调整程序。下面是每个指标的介绍：

* 最少持仓：当用户某支股票的持仓量低于设定值时，停止自动调整，使用户可以控制资产中有多少比例可以交给机器控制。

* 平均收益率：平均收益率刻画股票给用户带来的回报，因此若收益率不及用户期望，用户可以选择将其卖出。当用户某支股票的平均对数收益率低于设定值时，卖出股票。可以选择收益率的计算周期，包括日，周，月。

  设收盘价序列为$X$，其长度为$N$，则平均对数收益率$avgrt$可由如下公式得出：
  $$
  avgrt = \frac{\sum_{i=0}^{N-1} \log(X_{i+1}) - \log(X_i)}{N-1}
  $$
  
* 波动率：波动率刻画了股票的风险，用户可以通过设置规避过高风险的股票带来的影响。当用户某支股票的波动率高于设定值时，卖出股票。可以选择波动率的计算周期，包括日，周，月。

  设对数收益率序列为$R$，其长度为$N$，则波动率$\sigma$可由如下公式得出：
  $$
  \sigma = \sqrt{\frac{\sum_{i=0}^{N-1} R_{i+1} - R_i}{N-1}}
  $$
  
* 涨跌幅：涨跌幅直观地刻画了某支股票当前的变动情况，使得用户可以通过简单的数值设置来及时止损或止盈。当用户某支股票的涨跌幅高于（止盈）或低于（止亏）某个值时，卖出股票。可以选择涨跌幅的计算周期，包括日，周，月。

  设当日收盘价为$P_{now}$，$N$天前的收盘价为$P_{prev}$，则涨跌幅$r$的计算公式为：
  $$
  r = \frac{P_{now}-P_{prev}}{P_{prev}}
  $$
  

除此之外，如果用户设置了用于对冲的期权，还可以设置与期权有关的组合调整指标，在股票调整之后，若指标满足则可以通过包括期权在内的调整，使组合变动到推荐的比例：

* VaR：即Value at Risk，指在市场波动下，组合的在5%的可能下会出现的最大损失。用户如果担心可能的损失过大，就可以设定VaR值。系统计算组合的VaR值并与用户设定值比较，决定是否进行调整。

  VaR的计算公式如下：
  $$
  VaR_t = VaR^* \times \sigma_t - \mu_t
  $$
  其中，$VaR^*$取正态分布上95%分位点，$\mu_t,\sigma_t$代表对未来收益率均值、波动率的预测。

* 组合波动率、收益率、涨跌幅：除了单支股票以外，投资组合本身也可以用于计算波动率。与个股指标的区别在于，当组合的这些指标超限时，会统一卖出所有的股票。

* 实际比例与推荐比例的差值：Delta因子又称对冲值，表示资产价格变动时，期权价格的变化幅度。用户可以根据自己对变化的容忍度设定差值，平衡交易手续费与对冲风险。系统计算组合当前的Delta因子和推荐的Delta因子，当差值大于设定值时，对期权进行调整。

## 条件触发

相比于定期调整中的策略，在条件触发中设置的指标会进行实时的监测，当检测到指标满足触发条件就会进行调整。

在条件触发中可以设置所有定期调整中的指标。除定期调整外，其余的指标如下：

* 换手率：换手率衡量的是股票的流通性，一方面可以表明股票的购买和卖出的方便程度，另一方面也能反映股票潜在的短期波动率。用户可以设置换手率的范围，避免股票套牢或者极端波动。当用户某支股票的换手率超出设定范围时，卖出股票。

  换手率的计算公式为：
  $$
  Turnover = \frac{日成交量}{发行总股数} \times 100\%
  $$
  
* MACD：根据最近26日的收盘价，计算出指数平滑移动平均线（Moving Average Convergence and Divergence，简称MACD）。MACD是一种趋向类指标，展示出市场的变化形势，而且不会受到频繁波动产生假信号的影响，是判断是否买卖股票的重要分析指标。系统在当MACD值超出用户所设定的范围时，卖出股票。

  MACD的计算方法比较复杂，首先需要计算出平滑系数。设计算周期为$N$，则平滑系数$cof_N = \frac{2}{N+1}$。然后，计算指数平均值EMA，递推计算方法为$EMA_t = cof_N\times(X_t - EMA_{t+1})+EMA_{t+1}$，其中$X$为收盘指数，$t$从N开始逐步减小。计算出EMA12与EMA26之后，将可以得到差离值$DIF = EMA_{12} -EMA_{26}$。用DIF做同样的EMA步骤，可以得到DEA值，最后我们就得到DIF和DEA的差值$MACD = 2\times(DIF-DEA)$。当这个差值从大于0变化到小于0时意味着MACD死叉的出现，因此需要卖出。

* KDJ：根据最近9日的收盘价，最高价和最低价，计算随机指标中的K, D, J值。这个指标表明了股票价格走势的异动情况，可以反映超买超卖现象是否存在。这个指标融合了动量、强弱指标、移动平均线MA等的优点，可以用来快速、直观研判市场行情。通常来说，随机指标越高时，股票价格发生回落的可能性越大。因此当K, D, J中的某个值超出了用户设定的指标时，就会卖出股票。

  计算KDJ前，需要计算一个未成熟随机值RSV，即：
  $$
  RSV(n)=\frac{C_t-L_n}{H_n-L_n}\times 100
  $$
  其中$C_t,L_n,H_n$分别为第n日收盘价，n日内最低价，n日内最高价。然后，计算K值与D值：
  $$
  K_t=\frac{2}{3}K_{t-1}+\frac{1}{3}RSV_t\\
  D_t=\frac{2}{3}D_{t-1}+\frac{1}{3}K_t\\
  J_t = 3D_t-2K_t
  $$
  当$t-1$不存在，则设$K_{t-1},D_{t-1}$为50。

* RSI：根据近期的收盘价，计算相对强弱指数。RSI在0到100之间波动。这个指数通过比较收盘涨跌情况分析市场，表示市场趋势。一般情况下当RSI=30时，通常意味着存在超卖，RSI=70则存在超买。通常RSI有6, 12, 24日三个计算周期，当RSI值超过用户设定值时，卖出股票。

  假设计算周期为N，计算RSI先要计算一个初始值：
  $$
  RSI_0 = 100-(\frac{100}{1+\frac{\bar G_0}{\bar L_0}})
  $$
  其中$\bar G_0,\bar L_0$代表从第0天为起点，近N天的平均收益和平均亏损。有了初始值以后，有如下递推式：
  $$
  RSI_t = 100-(\frac{100}{1+\frac{(N-1)\bar G_{t-1}+G_t}{(N-1)\bar L_{t-1}+L_t}})
  $$
  其中$G_t,L_t$代表当天的收益和亏损。

* ROC：ROC是当天股价与之前某天股价的比较，变动速度的大小反应市场变化的快慢程度。根据用户指定的时间周期，以近期收盘价计算股价变动率。当ROC值超过用户设定的范围时，卖出股票。

  设计算的时间周期为N，ROC的计算方式如下：
  $$
  ROC = \frac{A_t}{B_t}
  $$
  其中$A_t = P_t - P_{t-N},B=P_{t-N}$，$P_t$代表第t日的收盘价。

* Sharpe Ratio：夏普比率综合考虑了资产的收益和风险，即承受一单位总风险，会得到多少超额收益。当夏普比越高，就说明资产更优越。系统在夏普比低于用户设置值时，卖出股票。

  夏普比的计算方法为：
  $$
  Sharpe Ratio = \frac{R_p-R_f}{\sigma_p}
  $$
  其中$R_p,R_f,\sigma_p$是组合收益率，无风险收益率，组合波动率。



  